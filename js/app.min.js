let formDataCalculator = new FormData();

function outputHints(select) {
    let cell = document.querySelector(select);
    let blockRegion = cell.querySelector('.form__inner_region');
    let blockLocality = cell.querySelector('.form__inner_locality');

    let valueRegion = {};
    let valueLocality = {};

    inputText(blockRegion, "region", 10);
    inputText(blockLocality, "city", 20);
    /* 
        Функция вывода подсказок при вводе текста.
        Принимает в параметрах:
            - поле ввода текста
            - блок для вывода подсказок
            - что ищем (регион или населнный пункт)
    */
    function inputText(block, searchContent, countLimit) {
        let fild = block.querySelector('.form__input');
        let blockHints = block.querySelector('.form__hints');
        /*
            Отслеживаем фокус на поле ввода.
            Если фокус исчезает, подсказки скрываются.
            Если фокус устанавливается, подсказки появляются.
        */
        (function () {
            fild.addEventListener('focus', (e) => {
                blockHints.classList.remove('display_off');
            });
            fild.addEventListener('blur', (e) => {
                blockHints.classList.add('display_off');
            });
            block.tabIndex = 0;
            block.addEventListener('focus', (e) => {
                blockHints.classList.remove('display_off');
                fild.focus();
            });
        }());
        /*
            Отслеживаем событие ввода текста и обрабатываем его.
            1. Удаляем все старые подсказки
            2. Если введено 3 и более символов, формируем запрос на сервер и отправляем его.
            3. При получении ответа, создаем новые подсказки и выводим их.
        */
        fild.addEventListener('input', function(e) {
            // Если есть подсказки, удаляем их
            function clearHints(select = blockHints) {
                let hints = select.querySelectorAll('.form__hints-element');
                if (hints.length > 0) {
                    for (let i = 0; i < hints.length; i++) {
                        hints[i].remove();
                    }
                };
            }
            clearHints();
            if (fild.value.length > 2) {
                let objectQuery = {};
                objectQuery = {
                    query: fild.value,
                    contentType: searchContent,
                    withParent: 1,
                    limit: countLimit
                };
                if (searchContent == "city" && valueRegion.id != null) {
                    objectQuery.regionId = +valueRegion.id;
                }
                let params = '';
                for (let key in objectQuery) {
                    if (params === '') {
                        params = `${key}=${objectQuery[key]}`;
                    } else {
                        params += `&${key}=${objectQuery[key]}`;
                    }
                }
                let ajax = new XMLHttpRequest();
                let url = 'http://logist-master/api/hints?' + params;
                ajax.open('get', url, false);
                ajax.addEventListener('readystatechange', function () {
                    if (this.readyState == 4 && this.status == 200) {
                        let res = JSON.parse(this.responseText)['result'];
                        for (let i = 1; i < res.length; i++) {
                            let hintElement = document.createElement('div');
                            hintElement.classList.add('form__hints-element');
                            if (searchContent == "region") {
                                let hintRegion = document.createElement('div');
                                hintRegion.classList.add('form__hints-region');
                                hintRegion.innerText = res[i]['name'] + " " + res[i]['type'].toLowerCase();
                                hintElement.append(hintRegion);
                            } else if (searchContent == "city") {
                                let hintCity = document.createElement('div');
                                hintCity.classList.add('form__hints-city');
                                hintCity.innerText = res[i]['typeShort'] + ". " + res[i]['name'] + " (" + res[i]['zip'] + ")";;
                                hintElement.append(hintCity);
                                let hintRegion = document.createElement('div');
                                hintRegion.classList.add('form__hints-region');
                                hintRegion.innerText = res[i]['parents'][0]['name'] + " " + res[i]['parents'][0]['typeShort'].toLowerCase();
                                if (res[i]['parents'].length > 1) {
                                    hintRegion.innerText += ", " + res[i]['parents'][1]['name'] + " " + res[i]['parents'][1]['typeShort'].toLowerCase() + '.';
                                }
                                hintElement.append(hintRegion);
                            }  
                            blockHints.append(hintElement);
                        }
                        /*
                            На каждый элемент подсказок вешаем событие клика.
                        */
                        let childrens = blockHints.children;
                        for (let i = 0; i < childrens.length; i++) {
                            childrens[i].addEventListener('click', function (e) {
                                if (searchContent == "region") {
                                    fild.value = res[i + 1]['name'] + " " + res[i + 1]['type'].toLowerCase();
                                    clearHints();
                                    valueRegion = res[i + 1];
                                    blockLocality.querySelector('.form__input').value = '';
                                    clearHints(blockLocality.querySelector('.form__hints'));
                                } else if (searchContent == "city") {
                                    fild.value = res[i + 1]['typeShort'].toLowerCase() + ". " + res[i + 1]['name'];
                                    clearHints();
                                    valueLocality = res[i + 1];
                                }
                            })
                        }
                    }
                });
                ajax.send();
            }
        });
    }

    /*
        Функция открывающая поле региона при клике на ссылку "Указать регион" и скрывающая ссылку.
    */
    (function () {
        let link = blockRegion.querySelector('.form__link');
        let inputRegion = blockRegion.querySelector('.form__input');
        link.addEventListener('click', (e) => {
            inputRegion.classList.remove('display_off');
            link.classList.add('display_off');
            inputRegion.focus();
        });
    }());
}
outputHints('.form__cell_from');
outputHints('.form__cell_where');



