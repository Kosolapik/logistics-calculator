
/*
    Функция для вывода выпадающих подсказок с городами.
    1. Вешает события ввода тескта на поле.
    2. Если введено 3 и более символов, отправляет запрос на наш сервер.
    3. При получении ответа, выводит его в выпадающих подсказках.
    4. На все выведеные подсказки вешает событие клика.
    5. При клике на одну из подсказок вставляет её значение в поле ввода. И удаляет все подсказки.
*/
function outputHints(select) {
    let block = document.querySelector(select);
    let inputs = block.querySelectorAll('.form__input');
    let dataListReg = block.querySelector('#from-region');
    let optionsReg = dataListReg.children;

    
    inputs[0].addEventListener('input', (e) => {
        // Если есть подсказки, удаляем их
        while (optionsReg.length > 0) {
            for (let i = 0; i < optionsReg.length; i++) {
                optionsReg[i].remove();
            }
        };

        if (inputs[0].value.length > 2) {
            arrQuery = {
                query: inputs[0].value,
                contentType: "region",
                withParent: 1,
                limit: 5
            };
            let params = '';
            for (let key in arrQuery) {
                if (params === '') {
                    params = `${key}=${arrQuery[key]}`;
                } else {
                    params += `&${key}=${arrQuery[key]}`;
                }
            }
console.log(params);
console.log(arrQuery);
            let ajax = new XMLHttpRequest();
            let url = 'http://logist-master/api/hints?' + params;
            ajax.open('get', url, false);
            ajax.addEventListener('readystatechange', function () {
                if (this.readyState == 4 && this.status == 200) {
                    let res = JSON.parse(this.responseText)['result'];
                    for (let i = 1; i < res.length; i++) {
                        console.log(res[i]);
                        let el = document.createElement('option');
                        el.value = res[i]['name'] + ' ' + res[i]['type'];
                        dataListReg.append(el);
                    }
                }
            });
            ajax.send();
        }
    })
}
outputHints('.from-calculator__cell_from');


/*
    Функция для отправки формы без перезагрузки страницы, получение ответа и вывод ответа на страницу
*/
function getDataForm(selectorForm) {
    let form = document.querySelector(selectorForm);
    let submit = form.querySelector('.form__submit');
    function sentForm(e) {
        e.preventDefault();
        let formData = new FormData(form);
        let ajax = new XMLHttpRequest();
        ajax.open('post', 'http://logist-master/api/calculator', false);
        ajax.addEventListener('readystatechange', function () {
            if (this.readyState == 4 && this.status == 200) {
                // console.log(this.responseText);
            }
        });
        ajax.send(formData);
        let showData = document.querySelector('.showData');
        let res = ajax.responseText;
        // res = JSON.parse(res);
        console.log((ajax));
        console.log(res);
        // console.log(formData);
        showData.innerHTML = res;

    }
    submit.addEventListener('click', sentForm);
}
getDataForm('.form-calculator');

/*
    Функция открывает поле для региона при нажатии на ссылку и скрывает ссылку.
*/
function openFieldForm(selector, input) {
    let inp = document.getElementsByName(input);
    let lab = document.querySelector(selector);
    lab.addEventListener('click', function () {
        inp[0].classList.toggle('display_off');
        lab.classList.toggle('display_off');
    });
}
openFieldForm('.link_where-region', 'where-region');
openFieldForm('.link_from-region', 'from-region');

